<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

        <section layout:fragment="contents" class="d-flex justify-content-center">
            <!-- 전체 layout -->
            <div class="main-contents">
                <!-- 입력 상자 -->
                <div class="input-box border rounded">
                    <textarea rows="4" class="form-control border-0" id="contentsInput"></textarea>
                    <div class="d-flex justify-content-between p-2">
                        <input type="file" id="fileInput" class="d-none">
                        <i class="bi bi-image img-icon" id="imageBtn"></i>
                        <button type="button" class="btn btn-info btn-sm" id="uploadBtn">입력</button>
                    </div>

                </div>
                <!-- /입력 상자 -->

                <!-- 타임라인 -->
                <div class="timeline my-4">
                    <!-- 카드 -->
                    <div class="card my-3" th:each="post:${postList}">
                        <div class="d-flex justify-content-between p-2">
                            <div th:text="${post.loginId}">lecture</div>
                            <i class="bi bi-three-dots-vertical more-btn" data-toggle="modal" data-target="#moreModal"></i>

                        </div>
                        <div>
                            <img class="w-100" th:src="${post.imagePath}" src="https://cdn.pixabay.com/photo/2025/03/06/08/25/blueberries-9450130_1280.jpg">
                        </div>
                        <div class="p-2">
                            <i th:if="${post.isLike}" class="bi bi-heart-fill text-danger unlike-btn"></i>
                            <i th:unless="${post.isLike}" class="bi bi-heart text-danger like-btn" th:data-post-id="${post.id}"></i>

                            <span>좋아요 <span th:text="${post.likeCount}">11</span>개</span>
                        </div>

                        <div class="p-2">
                            <b th:text="${post.loginId}">lecture</b> <span th:text="${post.contents}">반가워!</span>
                        </div>
                        <!-- 댓글 목록 -->
                        <div class="comment-box">
                            <div class="pl-2">댓글</div>
                            <div class="p-2">
                                <div th:each="comment:${post.commentList}">
                                    <b th:text="${comment.loginId}">marondal</b> <span th:text="${comment.contents}">우하하하</span>
                                </div>


                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="input-group">
                                    <input type="text" class="form-control" th:id="|commentInput${post.id}|">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-info comment-btn" th:data-post-id="${post.id}">게시</button>
                                    </div>

                                </div>

                            </div>
                        </div>

                    </div>
                    <!-- /카드 -->

                </div>
                <!-- /타임라인 -->


            </div>
            <!-- /전체 layout -->


        </section>

    <script layout:fragment="script">

        $(".comment-btn").on("click", function() {
            let postId = $(this).data("post-id");

            let comment = $("#commentInput" + postId).val();

            $.ajax({
                type:"post"
                , url:"/post/comment/write"
                , data:{"postId":postId, "contents":comment}
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("댓글 작성 실패!!")
                    }
                }
                , error:function() {
                    alert("댓글작성 에러!");
                }
            });
        });

        $(".like-btn").on("click", function() {

            let postId = $(this).data("post-id");

            $.ajax({
                type:"post"
                , url:"/post/like"
                , data:{"postId":postId}
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("좋아요 실패!");
                    }
                }
                , error:function() {
                    alert("좋아요 에러!");
                }

            });

        });

        $("#imageBtn").on("click", function() {
            $("#fileInput").click();
        });

        $("#uploadBtn").on("click", function() {
            let contents = $("#contentsInput").val();

            let file = $("#fileInput")[0].files[0];

            if(contents == "") {
                alert("내용을 입력하세요");
                return;
            }

            if(file == null) {
                alert("이미지를 선택하세요");
                return ;
            }

            let formData = new FormData();
            formData.append("contents", contents);
            formData.append("imageFile", file);

            $.ajax({
                type:"post"
                , "url":"/post/write"
                , data:formData
                , processData:false
                , contentType:false
                , success:function(response) {
                    if(response.result == "success") {
                        location.reload();
                    } else {
                        alert("글 작성 실패!");
                    }

                }
                , error:function() {
                    alert("글 작성 에러");
                }
            });


        });


    </script>

</html>